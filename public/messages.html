<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <title>Messages</title>
</head>
<body>
  <div id="header-container"></div>

  <div class="container">
    <!-- Sidebar -->
    <nav class="sidebar">
    <ul>
        <a href="/" class="nav-link">Dashboard</a>
        <a href="/students.html" class="nav-link">Students</a>
        <a href="/tasks.html" class="nav-link">Tasks</a>
    </ul>
</nav>

    <!-- Main Content -->
    <main class="main-content">
      <h1>Messages</h1>

      <div class="chat-layout">
        <!-- Chat rooms -->
<div class="chat-rooms">
  <div class="chat-header">
    <span>Chat room</span>
    <button class="new-chat-btn">+ New chat room</button>
  </div>
  <ul class="chat-room-list" id="chat-room-list"></ul>
</div>

<!-- Chat content -->
<div class="chat-window" id="chat-window" style="display: none;">
  <div class="chat-room-info">
    <div class="chat-room-name" id="room-name">Chat room Admin</div>
    <div class="chat-members">
      <span>Members:</span>
      <div class="member-list">
        <span class="member-icon">👤</span>
        <span class="member-icon">👤</span>
        <span class="member-icon">👤</span>
        <button class="add-member">+</button>
      </div>
    </div>
  </div>

  <div class="chat-messages" id="messages"></div>

  <div class="chat-input">
    <input type="text" id="messageInput" placeholder="Type your message..." />
    <button class="send-btn" id="sendBtn">▶</button>
  </div>
</div>

    </main>
  </div>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<script>
const socket = io('http://localhost:3000');
let currentRoom = '';
let currentUser = 'Bohdana';
let allStudents = [];

const chatRoomList = document.getElementById('chat-room-list');
const membersList = document.querySelector('.member-list');

fetch('/students')
  .then(res => res.json())
  .then(students => {
    console.log('✅ Студенти завантажені:', students); // Для відладки
    allStudents = students;
    initRandomRooms(students);
  })
  .catch(error => {
    console.error('❌ Помилка при завантаженні студентів:', error);
  });

function initRandomRooms(students) {
  const shuffled = students.sort(() => 0.5 - Math.random());
  const selected = shuffled.slice(0, 3);

  selected.forEach((st, index) => {
    const roomName = `Chat_${index + 1}`;
    const room = {
      name: roomName,
      members: [st]
    };
    createChatRoom(room);
  });
}

function createChatRoom(room) {
  const div = document.createElement('div');
  div.className = 'chat-room';
  div.innerText = room.name;
  div.onclick = () => joinRoom(room.name, room.members);
  chatRoomList.appendChild(div);
}

async function joinRoom(name, members) {
  currentRoom = name;
  document.getElementById('room-name').innerText = name;
  document.getElementById('chat-window').style.display = 'flex';

  // Очистити повідомлення та мемберів
  const messagesContainer = document.getElementById('messages');
  messagesContainer.innerHTML = '';
  membersList.innerHTML = '';

  members.forEach(m => {
    const span = document.createElement('span');
    span.className = 'member-icon';
    span.innerText = m.name[0]; 
    membersList.appendChild(span);
  });

  const addBtn = document.createElement('button');
  addBtn.className = 'add-member';
  addBtn.innerText = '+';
  addBtn.onclick = () => showAddMemberModal(name);
  membersList.appendChild(addBtn);

  socket.emit('joinRoom', name);

  try {
    const res = await fetch(`/messages/${name}`);
    const roomMessages = await res.json();
    roomMessages.forEach(addMessage);
  } catch (error) {
    console.error('Error loading messages:', error);
  }
}

function showAddMemberModal(room) {
  const select = document.createElement('select');
  allStudents.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.name + ' ' + s.surname;
    opt.innerText = s.name + ' ' + s.surname;
    select.appendChild(opt);
  });

  const confirmBtn = document.createElement('button');
  confirmBtn.innerText = 'Add';
  confirmBtn.onclick = () => {
    const selected = select.value;
    const span = document.createElement('span');
    span.className = 'member-icon';
    span.innerText = selected[0];
    membersList.insertBefore(span, membersList.lastChild);
    document.body.removeChild(modal);
  };

  const modal = document.createElement('div');
  modal.className = 'modalMess';
  const content = document.createElement('div');
  content.className = 'modalMess-content';
  content.innerHTML = '<h2>Add Member</h2>';
  content.appendChild(select);
  content.appendChild(confirmBtn);
  modal.appendChild(content);
  document.body.appendChild(modal);
}

document.getElementById('sendBtn').onclick = () => {
  const input = document.getElementById('messageInput');
  const msg = {
    chatroomId: currentRoom,
    authorId: 1, 
    text: input.value
  };
  socket.emit('sendMessage', msg);
  input.value = '';
};

socket.on('newMessage', addMessage);

socket.on('chatHistory', messages => {
  messages.forEach(addMessage);
});

function addMessage(msg) {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'message ' + (msg.authorId === 1 ? 'right' : 'left'); 
  div.innerHTML = `<div class="sender">${msg.authorId}</div><div class="bubble ${msg.authorId === 1 ? 'me' : ''}">${msg.text}</div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// Модалка створення нової кімнати
document.querySelector('.new-chat-btn').onclick = () => {
  const modal = document.createElement('div');
  modal.className = 'modalMess';

  const content = document.createElement('div');
  content.className = 'modalMess-content';

  content.innerHTML = `
    <div class="modalMess-body">
      <h2>Create New Chat Room</h2>
      <label>Room Name</label>
      <input type="text" id="roomNameInput" placeholder="Enter room name">
      <label>Choose Members</label>
<div id="membersCheckboxes" class="checkbox-container"></div>
    </div>
    <div class="modalMess-buttons">
      <button id="createRoomBtn">Create</button>
      <button id="cancelRoomBtn">Cancel</button>
    </div>
  `;

  modal.appendChild(content);
  document.body.appendChild(modal);

const checkboxContainer = content.querySelector('#membersCheckboxes');
allStudents.forEach(s => {
  const wrapper = document.createElement('div');
  wrapper.className = 'checkbox-item';

  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.value = JSON.stringify(s);
  checkbox.id = `student-${s.id}`;

  const label = document.createElement('label');
  label.htmlFor = checkbox.id;
  label.innerText = `${s.name} ${s.surname}`;

  wrapper.appendChild(checkbox);
  wrapper.appendChild(label);
  checkboxContainer.appendChild(wrapper);
});

  content.querySelector('#cancelRoomBtn').onclick = () => {
    document.body.removeChild(modal);
  };

  content.querySelector('#createRoomBtn').onclick = () => {
  const name = document.getElementById('roomNameInput').value.trim();
  const selected = Array.from(checkboxContainer.querySelectorAll('input[type="checkbox"]:checked'))
    .map(cb => JSON.parse(cb.value));

  if (!name || selected.length === 0) {
    alert('Fill all fields');
    return;
  }

  createChatRoom({ name, members: selected });
  document.body.removeChild(modal);
};

};

</script>

<script>
    fetch('header.html')
     .then(response => response.text())
     .then(data => {
         document.getElementById('header-container').innerHTML = data;
 
         const logoutBtn = document.getElementById("logoutBtn");
         if (logoutBtn) {
             logoutBtn.addEventListener("click", async function () {
                 try {
                     const response = await fetch("/logout");
                     const data = await response.json();
 
                     if (data.success) {
                      window.location.href = "/";
                    }
                 } catch (error) {
                     console.error("Logout failed:", error);
                 }
             });
         }
     })
     .catch(error => console.error('Error header.html:', error)); 
 </script>

  <script src="scripts.js"></script>
</body>
</html>